apiVersion: argoproj.io/v1alpha1
kind: Workflow                  #new type of k8s spec
metadata:
  generateName: biomedicus-wf-    #name of workflow spec
spec:
  entrypoint: biomedicus-test          #invoke the build template
  volumes:
  - name: test-volume
    hostPath:
      path: /Users/gms/workspace/test # must match host directory in minikube; cannot be symlinked
      # path: /Volumes/GrenziData/development/data
  
  templates:

  - name: biomedicus-test
    steps:
    - - name: elastic-server
        template: elastic-server
    - - name: elastic-client
        template: elastic-client
    #- - name: build  #name of template
    #    template: build-out
    #- - name: package  
    #    template: package-out

  - name: elastic-server
    daemon: true
    container:
      image: horcle/elastic
      imagePullPolicy: Never
      restartPolicy: Always
      ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
      livenessProbe:
        tcpSocket:
          port: transport
        initialDelaySeconds: 20
        periodSeconds: 10
      readinessProbe:
        httpGet:
          path: /_cluster/health
          port: http
        initialDelaySeconds: 20
        timeoutSeconds: 5      
      volumeMounts:
      - name: test-volume
        mountPath: /data
        readOnly: false

  - name: elastic-client
    container:
      image: horcle/elastic
      imagePullPolicy: Never
      command: ["/bin/sh", "-c"]
      args: ["echo curl 127.0.0.1:9200 && curl 127.0.0.1:9200"]

  - name: build-out
    container:
      image: horcle/biomedicus
      imagePullPolicy: Never
      command: ["/usr/share/biomedicus/bin/runCPE.sh"] 
      args: ["/usr/share/biomedicus/nlpie/PlainTextCPM_nlpie.xml"]
      volumeMounts:
      - name: test-volume
        mountPath: /data
        readOnly: false
      # resources:                #don't use too much resources
      #  limits:
      #    memory: 32Mi
      #    cpu: 100m
      
  - name:  package-out           
    container:
      image: horcle/biomedicus
      imagePullPolicy: Never
      command: [sh, -c]
      args: ["zip -r /data/biomedicus_out.zip /data/biomedicus_out"]
      volumeMounts:
      - name: test-volume
        mountPath: /data
        readOnly: false

